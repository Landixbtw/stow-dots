;;; auctex.el --- AUCTeX configuration for LaTeX workflow -*- lexical-binding: t; -*-

;; Basic AUCTeX setup
(use-package tex
  :straight auctex
  :defer t
  :mode ("\\.tex\\'" . latex-mode)
  :config
  (setq TeX-auto-save t
        TeX-parse-self t
        TeX-save-query nil
        TeX-PDF-mode t
        TeX-source-correlate-mode t
        TeX-source-correlate-method 'synctex
        TeX-view-program-selection '((output-pdf "Zathura")))

;; Math mode and basic settings
(add-hook 'LaTeX-mode-hook 'LaTeX-math-mode)
(add-hook 'LaTeX-mode-hook (lambda () (setq fill-column 100)))
(add-hook 'LaTeX-mode-hook 'auto-fill-mode)

;; PDF Tools
(use-package pdf-tools
  :straight t
  :config
  (pdf-tools-install)
  (setq TeX-view-program-list '(("PDF Tools" TeX-pdf-tools-sync-view))
        TeX-view-program-selection '((output-pdf "PDF Tools"))))

;; RefTeX
(use-package reftex
  :after tex
  :config
  (add-hook 'LaTeX-mode-hook 'turn-on-reftex)
  (setq reftex-plug-into-AUCTeX t
        reftex-ref-macro-prompt nil
        reftex-cite-prompt-optional-args t))

;; Company completion
(use-package company-auctex
  :straight t
  :after (tex company)
  :config
  (company-auctex-init))

;; Snippets
(use-package yasnippet
  :straight t
  :config
  (yas-global-mode 1))

(use-package yasnippet-snippets
  :straight t
  :after yasnippet)

;; Latexmk integration
(use-package auctex-latexmk
  :straight t
  :after tex
  :config
  (auctex-latexmk-setup)
  (setq auctex-latexmk-inherit-TeX-PDF-mode t)
  (add-to-list 'TeX-command-list
               '("Latexmk" "latexmk -pdf %s" TeX-run-TeX nil t
                 :help "Run Latexmk on file") t)
  (setq TeX-command-default "Latexmk"))

;; Math editing
(use-package cdlatex
  :straight t
  :after tex
  :hook (LaTeX-mode . turn-on-cdlatex)
  :config
  (setq cdlatex-math-symbol-alist
        '((?b ("\\mathbb" nil))
          (?c ("\\mathcal" nil))
          (?f ("\\mathfrak" nil))
          (?n ("\\mathnormal" nil))
          (?r ("\\mathrm" nil))
          (?s ("\\mathscr" nil)))))

;; Keybindings
(with-eval-after-load 'tex
  (define-key LaTeX-mode-map (kbd "C-c C-e") 'LaTeX-environment)
  (define-key LaTeX-mode-map (kbd "C-c C-s") 'LaTeX-section)
  (define-key LaTeX-mode-map (kbd "C-c C-m") 'LaTeX-insert-math))

;; Zathura configuration
(setq TeX-view-program-list
      '(("Zathura" "zathura %o"
         (mode-io-correlate "--synctex-forward %n:0:%b -x \"emacsclient +%{line} %{input}\""))))

;; Electric pairs
(add-hook 'LaTeX-mode-hook
          (lambda ()
            (setq-local electric-pair-pairs
                       (append '((?$ . ?$)) electric-pair-pairs))))

(provide 'auctex)
;;; auctex.el ends here
